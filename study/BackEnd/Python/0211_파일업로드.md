multipart
txt+ë‹¤ë¥¸format(ì´ë¯¸ì§€ íŒŒì¼ê°™ì€)ì„ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆê²Œ í•´ì¤Œ
ë¬¸ìì—´ì´ ì•„ë‹Œ í˜•íƒœì˜ íŒŒì¼ì„ backê³¼ frontê°€ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë„ë¡ í˜¼ìš©ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•´ì¤Œ
**back** python-multipart ì„¤ì¹˜
**front** htmlì— `<form enctype="multipart"></form>`

# async / await
ğŸ¤” ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”??

Promiseë¥¼ ë°˜í™˜í•˜ë©´ await ì‚¬ìš©  
axios, fetch, new Promise()ëŠ” Promiseë¥¼ ë°˜í™˜í•¨
asyncëŠ” í•¨ìˆ˜ ì„ ì–¸ ì‹œ ì‚¬ìš©
```
const event2 = async e => {
e.preventDefault()
const fileList = e.target.file.files
const txt = e.target.txt.value
const files = []
for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i]
    const base64File = await fileToBase64(file)
    files[i] = base64File
}
const params = { txt, files }
console.log(params)
axios.post('http://localhost:8000/upload2', params)
    .then(res => {
    console.log(res)
    })
    .catch(err => console.error(err))
}
```
ì—¬ê¸°ì„œ fileToBase64(file)ì´ Promiseë¥¼ ë°˜í™˜í•¨ ì™œëƒë©´!
```
 const fileToBase64 = file => {
    return new Promise((resolve, reject)=>{})
```
ì´ë ‡ê²Œ í•¨ìˆ˜ë¥¼ Promiseë¡œ ì§€ì •í–ˆê¸° ë•Œë¬¸  
ê·¸ë˜ì„œ consoleì— ì°ì—ˆì„ ë•Œ 
```
files: (2) [Promise, Promise]
422 error
```
422error(entity error) í™•ì¸í•˜ëŠ” ë°©ë²• => ê°œë°œìëª¨ë“œ => network => payloadì— ë­ ë„˜ì–´ê°€ëŠ”ì§€ ë³¼ ìˆ˜ ìˆìŒ
await ì—†ì„ ë•Œ consoleì— ì´ë ‡ê²Œ ë³´ì´ë©´ Promiseë¥¼ ë°˜í™˜ => await í•´ì¤˜ì•¼ ì´ê±¸ ì½ì–´ì˜¤ëŠ” ì‹œê°„ì„ ë²Œì–´ì¤Œ
await í›„ data ë³´ë‚¸ consoleì°ì–´ë³´ë©´ ê°’ ê°€ì ¸ì˜´
```
files: Array(2)
```


# frontì—ì„œ ë³´ë‚´ëŠ” 3ê°€ì§€ ë°©ë²•
1. form dataë¡œ ë³´ë‚´ëŠ” ë°©ì‹
```
const config = {
headers: {
    "Content-Type": "multipart/form-data"
}
}

const event = (e) => {
e.preventDefault()
console.log("ìš”ì²­")
const fileList = e.target.file.files
console.log(fileList)
const formData = new FormData()
formData.append("txt", e.target.txt.value)
for (let i = 0; i < fileList.length; i++) {
    console.log(fileList[i])
    formData.append("files", fileList[i])
}
axios.post('http://localhost:8000/upload', formData, config).then(res => console.log(res))
    .catch(err => console.error(err))
}
```
2. jsonìœ¼ë¡œ ë³´ë‚´ëŠ” ë°©ì‹
```
const event2 = async e => {
e.preventDefault()
const fileList = e.target.file.files
const txt = e.target.txt.value
const files = []
for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i]
    const base64File = await fileToBase64(file)
    files[i] = base64File
}
const params = { txt, files }
console.log(params)
axios.post('http://localhost:8000/upload2', params)
    .then(res => {
    console.log(res)
    })
    .catch(err => console.error(err))
}

const fileToBase64 = file => {
return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.readAsDataURL(file)

    reader.onload = () => {
    // console.log(reader.result)
    const data = reader.result.split(",")[1]
    resolve(data)
    }

    reader.onerror = err => {
    console.error(err)
    reject(err)
    }
})
}
```
3. useStateë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ì‹
```
const [files, setFiles] = useState([])
const config = {
headers: {
    "Content-Type": "multipart/form-data"
}
}
const event3 = e => {
e.preventDefault()
const formData = new FormData();
formData.append("txt", e.target.txt.value)
files.forEach(file => formData.append("files", file))
axios.post('http://localhost:8000/upload', formData, config)
    .then(res => console.log(res))
    .catch(err => console.error(err))
}
```

-----

## backì—ì„œ ë°›ëŠ” 2ê°€ì§€ ë°©ë²•
1. form í˜•íƒœë¡œ ë°›ì„ ë•Œ
```
@app.post("/upload")
def file_upload(files: List[UploadFile] = File(None), txt:str =Form('')):
í”„ë¡ íŠ¸íŒŒì¼ì—ì„œ í™•ì¸
  print(txt)
  print(files)
  return {"status": True}
```
- **frontì—ì„œ** ë³´ë‚¼ ë•Œ `"name"`ì— ë“  ì´ë¦„ìœ¼ë¡œ ë³€ìˆ˜ë¥¼ ì§€ì •í•´ì¤˜ì•¼í•¨ 
- `file: UploadFile` íŒŒì¼ì„ ì—…ë¡œë“œ í•œë‹¤ëŠ” ëœ»
- `=File()`íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ë°›ê² ë‹¤.
- íŒŒì¼ ì£¼ê³ ë°›ì„ê±°ë©´ ì´ ë‚´ìš©ì€ ê³ ì •
- `=File(None)`, `=Form('')`í•˜ë©´ ë¹ˆ ê°’ì„ ë³´ë‚´ë„ ì˜¤ë¥˜ ì•ˆ ë‚¨
2. JSONìœ¼ë¡œ ë°›ì„ ë•Œ
```
class fileModel(BaseModel):
  txt: str
  files: List[str]

@app.post('/upload2')
def upload(model:fileModel):
  print(model)
  return{"status":True}
```

3. backì— ì €ì¥í•˜ê¸°
```
def checkDir():
  UPLOAD_DIR.mkdir(exist_ok=True)

def saveFile(file):
  checkDir()
  path = UPLOAD_DIR / file.filename
  with path.open("wb") as f:
    shutil.copyfileobj(file.file, f)

@app.post("/upload")
def file_upload(files: List[UploadFile] = File(None), txt:str =Form('')):
  for file in files:
    saveFile(file)
  return {"status": True}
```
- ê²½ë¡œì— í´ë”ê°€ ìˆëŠ”ì§€ íŒë‹¨í•´ì„œ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì¤Œ ()ì•ˆì˜ ë‚´ìš© = í´ë”ê°€ ìˆì–´ë„ ì˜¤ë¥˜ ì•ˆë‚˜ê²Œ í—ˆìš©
- shutil.copyfileobj(ì›ë³¸, ë³µì œí•  ëŒ€ìƒ), ì´ë¯¸ ìˆëŠ” ê±° ë˜ ë„£ì–´ë„ ì˜¤ë¥˜ ì•ˆ ë‚¨
- getì€ ì˜¤ì§! ë¬¸ìì—´ë§Œ paramìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ
- post put fetchëŠ” íŒŒì¼ ì—…ë¡œë“œì— ì“¸ ìˆ˜ ìˆìŒ

---- 

- but!! ì´ë¦„ì´ ê°™ìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì”€ => **uuidë¡œ ì´ë¦„** ì§€ì–´ì£¼ê¸°
```
def saveFile(file):
  checkDir()
  origin = file.filename
  ext = origin.split(".")[-1].lower()
  newName = f'{uuid.uuid4().hex}.{ext}'
  path = UPLOAD_DIR / newName
  with path.open("wb") as f:
    shutil.copyfileobj(file.file, f)
```
- ext: í™•ì¥ëª… êº¼ë‚´ì˜¤ê¸°
- newName: ëœë¤ ì´ë¦„ ìƒì„±

4. íŒŒì¼ ë‹¤ìš´ë¡œë“œí•˜ê¸°
db ì—†ëŠ” ê²½ìš° ë”ë¯¸ dbë§Œë“¤ì–´ ì§„í–‰
```
db = []

def saveFile(file):
  checkDir()
  origin = file.filename
  ext = origin.split(".")[-1].lower()
  id = uuid.uuid4().hex
  newName = f'{uuid.uuid4().hex}.{ext}'
  data = {"id":id, "origin": origin, "ext":ext, "newName":newName} #ì–˜ë‘
  db.append(data)                                                  #ì–˜ê°€ ì¶”ê°€
  path = UPLOAD_DIR / newName
  with path.open("wb") as f:

@app.get('/download')
def download(id:str):
  for row in db:
    if row['id'] == id:
      origin = row['origin']
      newName = row['newName']
      break
  if newName:
    print(newName)
    path = UPLOAD_DIR / newName
    return FileResponse(path = path, filename = origin)
  return {"status":False}
```
- `return FileResponse(path = path, filename = origin)`:  
    ì—¬ê¸°ì„œ `origin`ì´ ë‹¤ìš´ë¡œë“œ ë°›ê²Œí•´ì£¼ëŠ” ìš©ë„
    `path`ëŠ” ë‹¨ìˆœíˆ ë§í¬ ì´ë™í•´ì„œ ë³´ê²Œí•´ì£¼ëŠ” ìš©ë„
- dbê°€ ìˆìœ¼ë©´ for ifë¬¸ì´ sqlë¬¸ìœ¼ë¡œ ë“¤ì–´ê°